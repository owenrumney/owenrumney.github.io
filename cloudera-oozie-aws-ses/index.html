<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Using AWS Simple Email Service with Oozie in Cloudera | Owen Rumney</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Using AWS Simple Email Service with Oozie in Cloudera" />
<meta name="author" content="Owen Rumney" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve moved to a new role where I will be doing a lot more “devops” type work which hopefully comes with more interesting subjects to start writing about." />
<meta property="og:description" content="I’ve moved to a new role where I will be doing a lot more “devops” type work which hopefully comes with more interesting subjects to start writing about." />
<link rel="canonical" href="https://www.owenrumney.co.uk/cloudera-oozie-aws-ses/" />
<meta property="og:url" content="https://www.owenrumney.co.uk/cloudera-oozie-aws-ses/" />
<meta property="og:site_name" content="Owen Rumney" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-10T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2017-03-10T00:00:00+00:00","datePublished":"2017-03-10T00:00:00+00:00","author":{"@type":"Person","name":"Owen Rumney"},"description":"I’ve moved to a new role where I will be doing a lot more “devops” type work which hopefully comes with more interesting subjects to start writing about.","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.owenrumney.co.uk/cloudera-oozie-aws-ses/"},"url":"https://www.owenrumney.co.uk/cloudera-oozie-aws-ses/","@type":"BlogPosting","headline":"Using AWS Simple Email Service with Oozie in Cloudera","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<meta name="keywords" content="aws,cloudera,linux" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" href="/favicon.ico"/>
<link rel="stylesheet" type="text/css" href="/assets/css/styles.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/prism.css" />
<script src="/assets/js/prism.js"></script>



</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TLCVNKXMFJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TLCVNKXMFJ');
</script>

<body>
    <div class="wrapper">
        <header class="wrapper-header">
            <div class="header">
  <nav class="float-right">
  
  <a href="https://github.com/owenrumney" target="_blank"
    ><img
      src="/assets/images/github.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="GitHub"
  /></a>
  
  <a href="https://linkedin.com/in/owenrumney" target="_blank"
    ><img
      src="/assets/images/linkedin.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="LinkedIn"
  /></a>
  
  <a href="https://cv.owenrumney.co.uk" target="_blank"
    ><img
      src="/assets/images/resume.svg"
      style="color: white; display: inline-block"
      height="32px"
      alt="Resume"
  /></a>
  
</nav>

  <a href="https://www.owenrumney.co.uk" target="_blank"><h1>Owen Rumney</h1></a>
  <br />
  <h5><i>Software Engineer</i></h5>
  <br />

  <hr />
</div>

        </header>

        <main class="wrapper-main">
            <div class="main-content">
            <div class="post-info">
    <h2>Using AWS Simple Email Service with Oozie in Cloudera</h2>
    <p>10 Mar 2017 - Owen Rumney</p>
</div>

<div class="post-content">
<p>I’ve moved to a new role where I will be doing a lot more “devops” type work which hopefully comes with more interesting subjects to start writing about.</p>

<h2 id="oozie-and-aws-simple-email-services">Oozie and AWS Simple Email Services</h2>

<p>The Cloudera cluster I have started working on is hosted in AWS and has all the security bells and whistles turned on; Kerberos, TLS etc.</p>

<p>Recently a support ticket came my way where the <code class="language-plaintext highlighter-rouge">Email Action</code> in Oozie was failing, on top of this there was no notification around job success and the <code class="language-plaintext highlighter-rouge">Kill</code> action wasn’t sending emails…. more than likely Oozie isn’t correctly configured for email.</p>

<p>As mentioned before, we use TLS everywhere possible and want to use Amazon’s Simple Email Service endpoint to relay the messages through. TLS SMTP isn’t supported directly with Oozie so there is a requirement to put something in the middle. In this case, the something is going to be <a href="http://www.postfix.org">postfix</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>There are a number of details you’ll need to get from AWS Management Console to get things set up.</p>

<p>In the AWS Management Console, navigate to the SES service and in the right hand side select SMTP settings. This is where you’ll find the endpoint you need to use and you can use the <code class="language-plaintext highlighter-rouge">Create SMTP Credentials</code> button at the bottom of the page to create some keys. _ Keep in mind that although these keys look like normal AWS Access Keys, they are actually SMTP keys and are specifically for authenticating with AWS SES _</p>

<p>Now on the left choose <code class="language-plaintext highlighter-rouge">Email Addresses</code> and follow the process for validating an email address as required by SES.</p>

<h2 id="installing-and-configuring-postfix">Installing and configuring postfix</h2>

<p>These steps assume that you’re running a <code class="language-plaintext highlighter-rouge">yum</code> flavoured Linux, its pretty much the same if you’re working with Ubuntu if you interchange the package tooling.</p>

<p>First we need to install postfix</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install postfix -y
</code></pre></div></div>

<p>The configuration for postfix is in <code class="language-plaintext highlighter-rouge">/etc/postfix/main.cf</code>. This is where the relay to AWS SES is going to be happening.</p>

<p>There are a couple of tweaks that needed to be done in this file in addition to adding the relayhost section.</p>

<ol>
  <li>Change the <code class="language-plaintext highlighter-rouge">inet_protocols</code> value to only ipv4 - <code class="language-plaintext highlighter-rouge">inet_interfaces=ipv4</code></li>
  <li>Change the <code class="language-plaintext highlighter-rouge">inet_interfaces</code>, in my case I just commented out the whole line <code class="language-plaintext highlighter-rouge">#inet_interfaces=localhost</code></li>
  <li>Add the <code class="language-plaintext highlighter-rouge">smtp_tls_CAFile</code>, in my case we’re using a pem file <code class="language-plaintext highlighter-rouge">smtp_tls_CAfile = /path/to/tls_cert.pem</code></li>
</ol>

<p>Now the <code class="language-plaintext highlighter-rouge">relayhost</code> section needs to be added so that it can forward to SES correctly.</p>

<p>In my case, I’m hosted in Ireland (<code class="language-plaintext highlighter-rouge">eu-west-1</code>) so my endpoint for SES is <code class="language-plaintext highlighter-rouge">email-smtp.eu-west-1.amazonaws.com</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>relayhost = [email-smtp.eu-west-1.amazonaws.com]:25
smtp_sasl_auth_enable = yes
smtp_sasl_security_options = noanonymous
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_use_tls = yes
smtp_tls_note_starttls_offer = yes
</code></pre></div></div>

<p>You can now save <code class="language-plaintext highlighter-rouge">main.cf</code>, we’ve finished with that.</p>

<p>You may have noticed the <code class="language-plaintext highlighter-rouge">smtp_sasl_password_maps</code> section pointing to a <code class="language-plaintext highlighter-rouge">sasl_passwd</code> file. We now need to create that. So create the file <code class="language-plaintext highlighter-rouge">/etc/postfix/sasl_passwd</code> and add the following using the credentials created for the SMTP user above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[email-smtp.eu-west-1.amazonaws.com]:25 &lt;smtpkey&gt;:&lt;smtpsecret&gt;
</code></pre></div></div>

<p>You can now create the hash of this file, set the ownership and permissions then remove the new <code class="language-plaintext highlighter-rouge">sasl_passwd</code> file with the cleartext keys</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo postmap hash:/etc/postfix/sasl_passwd
sudo chown root:root /etc/postfix/sasl_passwd.db
sudo chmod 0600 /etc/postfix/sasl_passwd.db
sudo rm /etc/postfix/sasl_passwd
</code></pre></div></div>

<p>Now all you need to do is start the service <code class="language-plaintext highlighter-rouge">sudo postfix start</code></p>

<h2 id="configuring-oozie">Configuring Oozie</h2>

<p>You can configure Oozie in Cloudera Manager. Go to Oozie service -&gt; Configuration. Set <code class="language-plaintext highlighter-rouge">oozie.email.smtp.host</code> and set the value to the IP address of the server you’ve installed postfix. (To keep it simple, I installed postfix on the Oozie server itself. I had to use the IP as Oozie doesn’t like <code class="language-plaintext highlighter-rouge">localhost</code>)</p>

<p>Set the <code class="language-plaintext highlighter-rouge">oozie.email.from.address</code> you’re going to be sending from to the value setup in SES Management Console email address page.</p>

<p>Restart Oozie and Hue then create a test workflow with an <code class="language-plaintext highlighter-rouge">Email Action</code> sending an email and run. All being well, the email will be sent and the workflow action will go green. Check the logs of the workflow if it doesn’t work, it should be clear from there.</p>

</div>

            </div>
        </main>
    </div>

    <footer class="wrapper-footer">
        <div class="footer">
    <span class="footer-text float-left">This work is licensed under <a rel="license" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank">GPLv3</a></span>
    <span class="footer-text float-right">
    Site Updated: 2023-12-01  (<a href="/feed.xml" target="_blank">RSS</a>)
  </span>
</div>
    </footer>
</body>
</html>
