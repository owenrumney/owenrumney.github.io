<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deploying Prometheus to Kubernetes | Owen Rumney</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Deploying Prometheus to Kubernetes" />
<meta name="author" content="Owen Rumney" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documenting the steps required to run Prometheus in Kubernetes" />
<meta property="og:description" content="Documenting the steps required to run Prometheus in Kubernetes" />
<link rel="canonical" href="https://www.owenrumney.co.uk/running-prometheus-in-k8s/" />
<meta property="og:url" content="https://www.owenrumney.co.uk/running-prometheus-in-k8s/" />
<meta property="og:site_name" content="Owen Rumney" />
<meta property="og:image" content="https://www.owenrumney.co.uk/assets/img/owen.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-03T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2022-08-03T00:00:00+00:00","datePublished":"2022-08-03T00:00:00+00:00","author":{"@type":"Person","name":"Owen Rumney"},"description":"Documenting the steps required to run Prometheus in Kubernetes","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.owenrumney.co.uk/running-prometheus-in-k8s/"},"url":"https://www.owenrumney.co.uk/running-prometheus-in-k8s/","@type":"BlogPosting","image":"https://www.owenrumney.co.uk/assets/img/owen.png","headline":"Deploying Prometheus to Kubernetes","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<meta name="keywords" content="kubernetes,learning,monitoring" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" href="/favicon.ico"/>
<link rel="stylesheet" type="text/css" href="/assets/css/styles.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/prism.css" />
<script src="/assets/js/prism.js"></script>



</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TLCVNKXMFJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TLCVNKXMFJ');
</script>

<body>
    <div class="wrapper">
        <header class="wrapper-header">
            <div class="header">
  <nav class="float-right">
  
  <a href="https://github.com/owenrumney" target="_blank"
    ><img
      src="/assets/images/github.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="GitHub"
  /></a>
  
  <a href="https://linkedin.com/in/owenrumney" target="_blank"
    ><img
      src="/assets/images/linkedin.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="LinkedIn"
  /></a>
  
  <a href="https://cv.owenrumney.co.uk" target="_blank"
    ><img
      src="/assets/images/resume.svg"
      style="color: white; display: inline-block"
      height="32px"
      alt="Resume"
  /></a>
  
</nav>

  <a href="https://www.owenrumney.co.uk" target="_blank"><h1>Owen Rumney</h1></a>
  <br />
  <h5><i>Software Engineer</i></h5>
  <br />

  <hr />
</div>

        </header>

        <main class="wrapper-main">
            <div class="main-content">
            <div class="post-info">
    <h2>Deploying Prometheus to Kubernetes</h2>
    <p>03 Aug 2022 - Owen Rumney</p>
</div>

<div class="post-content">
<h2 id="what-is-this-about">What is this about?</h2>

<p>This blog post is kind of a learning in public exercise. The goal is to run Prometheus in my local K8s cluster and export Node metrics to it.</p>

<p>I’m using a cluster generated by <a href="https://github.com/owenrumney/local_k8s">my local_k8s</a> project. Out of the box, this creates KVM hosted cluster on an Arch machine with an underlying NFS ready for Persisted Volumes; PRs and Issues welcome.</p>

<h2 id="creating-the-namespace">Creating the namespace</h2>

<p>The first thing we want to do is create a namespace to run the monitoring resources in. I’m going to call this <code class="language-plaintext highlighter-rouge">monitoring</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create namespace monitoring
</code></pre></div></div>

<p>This is the logical grouping for all the resources related to monitoring to be placed, this will be the Pods, ConfigMaps, Services, Secrets etc</p>

<h2 id="access-control">Access Control</h2>

<p>This first section will configure the access control for a service account to run Prometheus for us.</p>

<h3 id="service-account">Service Account</h3>

<p>I want to run monitoring as its own dedicated service account, so lets create the manifest file for that.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># monitor-sa.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</code></pre></div></div>

<p>This will create a service account in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace called <code class="language-plaintext highlighter-rouge">monitor</code>.</p>

<p>Create:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> monitor-sa.yaml
</code></pre></div></div>

<h3 id="cluster-role">Cluster role</h3>

<p>Now that we have a service account, we need to give some permissions to it. Using the Role Based Access Control (RBAC) for Kubernetes, this requires a dedicated role for the access that is required.</p>

<p>Our service account in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace needs to be able to access resources across the cluster, so this needs to be a <code class="language-plaintext highlighter-rouge">ClusterRole</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># monitor-cluster-role.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitor</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
</code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">ClusterRole</code> grants holders of the role to be able to <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">list</code> and <code class="language-plaintext highlighter-rouge">watch</code> a selection of resources (<code class="language-plaintext highlighter-rouge">nodes</code>, <code class="language-plaintext highlighter-rouge">services</code>, <code class="language-plaintext highlighter-rouge">endpoints</code> and <code class="language-plaintext highlighter-rouge">pods</code>).</p>

<p>Create:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> monitor-cluster-role.yaml
</code></pre></div></div>

<h3 id="binding">Binding</h3>

<p>There is nothing linking our <code class="language-plaintext highlighter-rouge">monitor</code> service account to the <code class="language-plaintext highlighter-rouge">monitor</code> role at the moment, for this we need a <code class="language-plaintext highlighter-rouge">ClusterRoleBinding</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># monitor-cluster-role-binding.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitor</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitor</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitor</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</code></pre></div></div>

<p>This manifest is binding the <code class="language-plaintext highlighter-rouge">ClusterRole</code> <code class="language-plaintext highlighter-rouge">monitor</code> to the service account <code class="language-plaintext highlighter-rouge">monitor</code> from the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace.</p>

<p>Create:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> monitor-cluster-role-binding.yaml
</code></pre></div></div>

<h3 id="validating-access">Validating Access</h3>

<p>At this stage, we want to verify that our new service account can do what we’ve set in the permissions. To do this, we can use the <code class="language-plaintext highlighter-rouge">auth can-i</code> command provided by <code class="language-plaintext highlighter-rouge">kubectl</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl auth can-i watch pods <span class="nt">--as</span> system:serviceaccount:monitoring:monitor
</code></pre></div></div>

<p>This command checks if the service account <code class="language-plaintext highlighter-rouge">monitor</code> in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace can <code class="language-plaintext highlighter-rouge">watch (verb)</code> <code class="language-plaintext highlighter-rouge">pods (resource)</code>. Thankfully the answer is an emphatic <code class="language-plaintext highlighter-rouge">yes</code></p>

<h2 id="deploying-prometheus">Deploying Prometheus</h2>

<p>In this section I will cover the actual deployment of Prometheus</p>

<h3 id="configuration">Configuration</h3>

<p>Lets store the configuration for Prometheus in a config map. As everything is running in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace, we can create the config map there.</p>

<p>We need a config to put in the map, this configures the scrapes that Prometheus will perform and some additional global settings.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#prometheus.yml </span>

<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">15s</span> <span class="c1"># scrape every 15 seconds</span>
  <span class="na">external_labels</span><span class="pi">:</span>
    <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">cluster'</span>

<span class="na">scrape_configs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">5s</span>
  <span class="na">static_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9090'</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">kubernetes-service-endpoints'</span>
  <span class="na">kubernetes_sd_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s">endpoints</span>
  <span class="na">relabel_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">labelmap</span>
    <span class="na">regex</span><span class="pi">:</span> <span class="s">__meta_kubernetes_service_label_(.+)</span>
  <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_namespace</span><span class="pi">]</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
    <span class="na">target_label</span><span class="pi">:</span> <span class="s">kubernetes_namespace</span>
  <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_service_name</span><span class="pi">]</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">replace</span>
    <span class="na">target_label</span><span class="pi">:</span> <span class="s">kubernetes_name</span>
</code></pre></div></div>

<p>Create: (pay attention to creating in correct namespace)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> monitoring create configmap prometheus-config <span class="nt">--from-file</span> prometheus.yml
</code></pre></div></div>

<h3 id="deployment">Deployment</h3>

<p>I’m going to deploy as a single replica for this example and use a <code class="language-plaintext highlighter-rouge">Deployment</code> rather than just a <code class="language-plaintext highlighter-rouge">Pod</code> so that any restarts are handled nicely.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># prometheus-deployment.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">prom/prometheus</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/prometheus/prometheus.yml</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">prometheus.yml</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9090</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-config</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">monitor</span>
</code></pre></div></div>

<p>Create:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> prometheus-deployment.yaml
</code></pre></div></div>

<h3 id="service">Service</h3>

<p>Now we have the Prometheus pods running, we need a service to actually get to the UI from our browser.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># prometheus-service.yaml</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">promui</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">39090</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">9090</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div></div>

<h3 id="viewing-prometheus">Viewing Prometheus</h3>

<p>To view the dashboard lets open up Prometheus with a simple port forward, (an ingress would be better, but this is quicker)</p>

<p>First, find the name of the pod</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-n</span> monitoring
</code></pre></div></div>

<p>Making a note of the Pod name, we can create a port forward</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward <span class="nt">-n</span> monitoring prometheus-deployment-6559cbc88b-9m9hv 8080:9090
</code></pre></div></div>

<p>Now if we browse to <code class="language-plaintext highlighter-rouge">http://localhost:8080</code> we can see the Prometheus dashboard.</p>

<p><img src="../images/prometheus_dashboard.png" alt="Prometheus Dashboard" /></p>

<h2 id="node-exporter">Node Exporter</h2>

<p>There are a few more steps to see the Node Exporter metrics</p>

<h3 id="adding-exporter-pod">Adding Exporter Pod</h3>

<p>We need a pod per node to get the metrics, so the clear choice is deploying as a <code class="language-plaintext highlighter-rouge">DaemonSet</code>. These pods will run in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># node-exporter-daemonset.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">exporter</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">exporter</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">exporter</span>
        <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">node-exporter</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">--path.sysfs=/host/sys</span>
        <span class="pi">-</span> <span class="s">--path.rootfs=/host/root</span>
        <span class="pi">-</span> <span class="s">--no-collector.wifi</span>
        <span class="pi">-</span> <span class="s">--no-collector.hwmon</span>
        <span class="pi">-</span> <span class="s">--collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span>
        <span class="pi">-</span> <span class="s">--collector.netclass.ignored-devices=^(veth.*)$</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">prom/node-exporter</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9100</span>
            <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/sys</span>
          <span class="na">mountPropagation</span><span class="pi">:</span> <span class="s">HostToContainer</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">sys</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/root</span>
          <span class="na">mountPropagation</span><span class="pi">:</span> <span class="s">HostToContainer</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">root</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/sys</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">sys</span>
      <span class="pi">-</span> <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">root</span>
</code></pre></div></div>

<p>Note that we’re mounting <code class="language-plaintext highlighter-rouge">sys</code> and <code class="language-plaintext highlighter-rouge">root</code> from the host to be able to read from the host.</p>

<p>Create:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> node-exporter-daemonset.yaml
</code></pre></div></div>

<h3 id="node-exporter-1">Node Exporter</h3>

<p>For the metrics to be surfaced we need a service for the node-exporter. Again this will be running in the <code class="language-plaintext highlighter-rouge">monitoring</code> namespace.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># node-exporter-service.yaml</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">annotations</span><span class="pi">:</span>
      <span class="na">prometheus.io/scrape</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
      <span class="na">prometheus.io/port</span><span class="pi">:</span>   <span class="s1">'</span><span class="s">9100'</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
      <span class="na">app.kubernetes.io/component</span><span class="pi">:</span> <span class="s">exporter</span>
      <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">9100</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">9100</span>
</code></pre></div></div>
<p><em>node-exporter-service.yaml</em></p>

<h3 id="adding-a-scrape-job">Adding a scrape job</h3>

<p>The last thing left, we need to add a job to <code class="language-plaintext highlighter-rouge">prometheus.yml</code> and update the config map.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">node-exporter'</span>
  <span class="na">kubernetes_sd_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">role</span><span class="pi">:</span> <span class="s">endpoints</span>
  <span class="na">relabel_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_endpoints_name</span><span class="pi">]</span>
    <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">node-exporter'</span>
    <span class="na">action</span><span class="pi">:</span> <span class="s">keep</span>
</code></pre></div></div>

<p>This adds a job that will look for node exporter metrics.</p>

<h3 id="checking-the-end-result">Checking the end result</h3>

<p>Now we can create the port forward again</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward <span class="nt">-n</span> monitoring prometheus-deployment-6559cbc88b-94dsf 8080:9090
</code></pre></div></div>

<p>We can see a number of metrics now in the metrics explorer. Try adding the expression <code class="language-plaintext highlighter-rouge">node_memory_MemFree_bytes</code> and pressing <code class="language-plaintext highlighter-rouge">Execute</code> button.</p>

<p>Over a period of time, this will give you a graph of free memory for the nodes in your cluster.</p>

<p><a href="../images/prometheus_node_exporter.png">![Node Exporter Memory Metrics](../image</a>](../image](../images/prometheus_node_exporter.png){:target=”_blank”}</p>

</div>

            </div>
        </main>
    </div>

    <footer class="wrapper-footer">
        <div class="footer">
    <span class="footer-text float-left">This work is licensed under <a rel="license" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank">GPLv3</a></span>
    <span class="footer-text float-right">
    Site Updated: 2023-12-01  (<a href="/feed.xml" target="_blank">RSS</a>)
  </span>
</div>
    </footer>
</body>
</html>
