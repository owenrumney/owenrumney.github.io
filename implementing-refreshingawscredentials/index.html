<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>RefreshingAWSCredentials with .NET | Owen Rumney</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="RefreshingAWSCredentials with .NET" />
<meta name="author" content="Owen Rumney" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Steps required to handle refreshing AWS credentials when using the AWS .NET SDK" />
<meta property="og:description" content="Steps required to handle refreshing AWS credentials when using the AWS .NET SDK" />
<link rel="canonical" href="https://www.owenrumney.co.uk/implementing-refreshingawscredentials/" />
<meta property="og:url" content="https://www.owenrumney.co.uk/implementing-refreshingawscredentials/" />
<meta property="og:site_name" content="Owen Rumney" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-09T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2019-01-09T00:00:00+00:00","datePublished":"2019-01-09T00:00:00+00:00","author":{"@type":"Person","name":"Owen Rumney"},"description":"Steps required to handle refreshing AWS credentials when using the AWS .NET SDK","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.owenrumney.co.uk/implementing-refreshingawscredentials/"},"url":"https://www.owenrumney.co.uk/implementing-refreshingawscredentials/","@type":"BlogPosting","headline":"RefreshingAWSCredentials with .NET","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<meta name="keywords" content="aws,programming" />

<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" href="/favicon.ico"/>
<link rel="stylesheet" type="text/css" href="/assets/css/styles.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/prism.css" />
<script src="/assets/js/prism.js"></script>



</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TLCVNKXMFJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TLCVNKXMFJ');
</script>

<body>
    <div class="wrapper">
        <header class="wrapper-header">
            <div class="header">
  <nav class="float-right">
  
  <a href="https://github.com/owenrumney" target="_blank"
    ><img
      src="/assets/images/github.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="GitHub"
  /></a>
  
  <a href="https://linkedin.com/in/owenrumney" target="_blank"
    ><img
      src="/assets/images/linkedin.svg"
      style="color: white; display: inline-block"
      height="30px"
      alt="LinkedIn"
  /></a>
  
  <a href="https://cv.owenrumney.co.uk" target="_blank"
    ><img
      src="/assets/images/resume.svg"
      style="color: white; display: inline-block"
      height="32px"
      alt="Resume"
  /></a>
  
</nav>

  <a href="https://www.owenrumney.co.uk" target="_blank"><h1>Owen Rumney</h1></a>
  <br />
  <h5><i>Software Engineer</i></h5>
  <br />

  <hr />
</div>

        </header>

        <main class="wrapper-main">
            <div class="main-content">
            <div class="post-info">
    <h2>RefreshingAWSCredentials with .NET</h2>
    <p>09 Jan 2019 - Owen Rumney</p>
</div>

<div class="post-content">
<p>Where I am currently working we have Single Sign On for AWS API calls and need to use task accounts to connect and get temporary credentials. To that end, its not very easy to have long running processes making calls to AWS API’s such as S3 and SQS.</p>

<p>I am working a proof of concept which has a 3rd party .NET component which listens to SQS messages, calls into a proprietary API then dumps the results on S3. This code wasn’t written by people who knew about the hoops we need to authenticate.</p>

<p>To complicate things, the context the application runs under isn’t the context of the service account which has been granted rights to the appropriate role and the instance profile doesn’t have the correct rights. (For reasons I won’t go into, the Ops team won’t correct this).</p>

<p>So, having written that, I realise we’re looking at a very niche use case, but if it looks familiar, read on.</p>

<h2 id="solution">Solution</h2>

<p>Behind the scenes, there is a PowerShell in the background running as a scheduled task to go through Single Sign On and get new tokens to write in the credential file. I won’t go into any more detail than that as its very company specific.</p>

<p>As the 3rd party application creates the client on startup it uses the latest credentials but they don’t get refreshed from the credential file. I found an abstract class in the .NET SDK called <code class="language-plaintext highlighter-rouge">RefreshingAWSCredentials</code> which looked promising.</p>

<p>With this class, you can set an expiration for the Credential object such that any AWS SDK client that is using it for the API calls - for example;</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">s3Client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmazonS3Client</span><span class="p">(</span><span class="n">ExternalRefreshingAWSCredentilas</span><span class="p">.</span><span class="n">Credentials</span><span class="p">);</span>
</code></pre></div></div>

<p>will create an S3Client that is given the refreshing credentials specified below.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Amazon.Runtime</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Amazon.Runtime.CredentialManagement</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">log4net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Configuration</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AwsCredentialsExample.Credentials</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ExternalRefreshingAWSCredentials</span> <span class="p">:</span> <span class="n">RefreshingAWSCredentials</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">lockObj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Object</span><span class="p">();</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ILog</span> <span class="n">Logger</span> <span class="p">=</span> <span class="n">LogManager</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ExternalRefreshingAWSCredentials</span><span class="p">));</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">credentialFileProfile</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">credentialFileLocation</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">ExternalRefreshingAWSCredentials</span> <span class="n">refreshingCredentials</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">CredentialsRefreshState</span> <span class="n">credentialRefreshState</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">int</span> <span class="n">refreshMinutes</span> <span class="p">=</span> <span class="m">45</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">ExternalRefreshingAWSCredentials</span> <span class="n">Credentials</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">refreshingCredentials</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">lock</span> <span class="p">(</span><span class="n">lockObj</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">refreshingCredentials</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">refreshingCredentials</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExternalRefreshingAWSCredentials</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">refreshingCredentials</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="nf">ExternalRefreshingAWSCredentials</span><span class="p">()</span>
        <span class="p">{</span>
             <span class="n">credentialFileProfile</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"CredentialFileProfile"</span><span class="p">];</span>
             <span class="n">credentialFileLocation</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"CredentialFileLocation"</span><span class="p">];</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">.</span><span class="nf">HasKey</span><span class="p">(</span><span class="s">"ClientRefreshIntervalMinutes"</span><span class="p">))</span>
             <span class="p">{</span>
                 <span class="n">refreshMinutes</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">"ClientRefreshIntervalMinutes"</span><span class="p">));</span>
             <span class="p">}</span>
             <span class="n">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Credential file location is {0}"</span><span class="p">,</span> <span class="n">credentialFileLocation</span><span class="p">));</span>
              <span class="n">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Credential file profile is {0}"</span><span class="p">,</span> <span class="n">credentialFileProfile</span><span class="p">));</span>
            <span class="n">credentialRefreshState</span> <span class="p">=</span> <span class="nf">GenerateNewCredentials</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ClearCredentials</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"Clearing the credentials"</span><span class="p">);</span>
            <span class="n">credentialRefreshState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="n">CredentialsRefreshState</span> <span class="nf">GenerateNewCredentials</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Generating credentials, valid for {0} minutes"</span><span class="p">,</span> <span class="n">refreshMinutes</span><span class="p">));</span>
            <span class="kt">var</span> <span class="n">credFile</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StoredProfileAWSCredentials</span><span class="p">(</span><span class="n">credentialFileProfile</span><span class="p">,</span> <span class="n">credentialFileLocation</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">CredentialsRefreshState</span><span class="p">(</span><span class="n">credFile</span><span class="p">.</span><span class="nf">GetCredentials</span><span class="p">(),</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddMinutes</span><span class="p">(</span><span class="n">refreshMinutes</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">ImmutableCredentials</span> <span class="nf">GetCredentials</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">credentialRefreshState</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">credentialRefreshState</span><span class="p">.</span><span class="n">Expiration</span> <span class="p">&lt;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">credentialRefreshState</span> <span class="p">=</span> <span class="nf">GenerateNewCredentials</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">credentialRefreshState</span><span class="p">.</span><span class="n">Credentials</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>There are three configurations to be used with this. These should be added as AppSettings in the app.config</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">CredentialFileLocation</code> - The location of the credential file that is being updated externally (in this case by PowerShell)</li>
  <li><code class="language-plaintext highlighter-rouge">CredentialFileProfile</code> - The profile from the credential file to use</li>
  <li><code class="language-plaintext highlighter-rouge">ClientRefreshIntervalMinutes</code> - How long to keep the credentials before expiring them (defaults to 45 minutes)</li>
</ol>

<p>As suggested before, you can now create your AWS clients passing in the <code class="language-plaintext highlighter-rouge">Credentials</code> property in place of any of the normally used <code class="language-plaintext highlighter-rouge">Credentials</code> objects.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">s3Client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmazonS3Client</span><span class="p">(</span><span class="n">ExternalRefreshingAWSCredentials</span><span class="p">.</span><span class="n">Credentials</span><span class="p">);</span>
</code></pre></div></div>

</div>

            </div>
        </main>
    </div>

    <footer class="wrapper-footer">
        <div class="footer">
    <span class="footer-text float-left">This work is licensed under <a rel="license" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank">GPLv3</a></span>
    <span class="footer-text float-right">
    Site Updated: 2023-12-01  (<a href="/feed.xml" target="_blank">RSS</a>)
  </span>
</div>
    </footer>
</body>
</html>
